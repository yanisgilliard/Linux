# Module 2 : Sauvegarde du systÃ¨me de fichiers

## Sommaire

- [Module 2 : Sauvegarde du systÃ¨me de fichiers](#module-2--sauvegarde-du-systÃ¨me-de-fichiers)
  - [Sommaire](#sommaire)
  - [I. Script de backup](#i-script-de-backup)
    - [1. Ecriture du script](#1-ecriture-du-script)
    - [2. Clean it](#2-clean-it)
    - [3. Service et timer](#3-service-et-timer)
  - [II. NFS](#ii-nfs)
    - [1. Serveur NFS](#1-serveur-nfs)
    - [2. Client NFS](#2-client-nfs)

## I. Script de backup

### 1. Ecriture du script

ğŸŒ **Ecrire le script `bash`**

The script can be found : [here](tp6_backup.sh)

Example of output :

```bash
[yanis@web srv]$ sudo ./tp6_backup.sh 
Filename : nextcloud_20230110113107.tar.gz saved in /srv/backup
```

### 3. Service et timer

ğŸŒ **CrÃ©ez un *service*** systÃ¨me qui lance le script

```bash
[yanis@web system]$ sudo systemctl status backup
â—‹ backup.service - Backup script for nextcloud
     Loaded: loaded (/etc/systemd/system/backup.service; static)
     Active: inactive (dead)
[yanis@web srv]$ sudo systemctl start backup
[yanis@web srv]$ sudo systemctl status backup
â—‹ backup.service - Backup script for nextcloud
     Loaded: loaded (/etc/systemd/system/backup.service; static)
     Active: inactive (dead)

Jan 10 11:54:03 web systemd[1]: Starting Backup script for nextcloud...
Jan 10 11:54:03 web bash[14913]: tar: Removing leading `/` from member names
Jan 10 11:54:52 web bash[14911]: Filename : nextcloud_20230110115403.tar.gz saved in /srv/backup
Jan 10 11:54:52 web systemd[1]: backup.service: Deactivated successfully.
Jan 10 11:54:52 web systemd[1]: Finished Backup script for nextcloud.
Jan 10 11:54:52 web systemd[1]: backup.service: Consumed 34.619s CPU time.
[yanis@web srv]$ cd backup/
[yanis@web backup]$ ls
nextcloud_20230110115403.tar.gz

```

ğŸŒ **CrÃ©ez un *timer*** systÃ¨me qui lance le *service* Ã  intervalles rÃ©guliers

- le fichier doit Ãªtre crÃ©Ã© dans le mÃªme dossier
- le fichier doit porter le mÃªme nom
- l'extension doit Ãªtre `.timer` au lieu de `.service`
- ainsi votre fichier s'appellera `backup.timer`
- la syntaxe est la suivante :

```systemd
[Unit]
Description=Run service X

[Timer]
OnCalendar=*-*-* 4:00:00

[Install]
WantedBy=timers.target
```

> [La doc Arch est cool Ã  ce sujet.](https://wiki.archlinux.org/title/systemd/Timers)

ğŸŒ Activez l'utilisation du *timer*

- vous vous servirez des commandes suivantes :

```bash

$ sudo systemctl daemon-reload

$ sudo systemctl start backup.timer
$ sudo systemctl enable backup.timer
$ sudo systemctl status backup.timer

$ sudo systemctl list-timers
```

## II. NFS

### 1. Serveur NFS

> On a dÃ©jÃ  fait Ã§a au TP4 ensemble :)

ğŸ–¥ï¸ **VM `storage.tp6.linux`**

**N'oubliez pas de dÃ©rouler la [ğŸ“**checklist**ğŸ“](../../2/README.md#checklist).**

ğŸŒ **PrÃ©parer un dossier Ã  partager sur le rÃ©seau** (sur la machine `storage.tp6.linux`)

- crÃ©er un dossier `/srv/nfs_shares`
- crÃ©er un sous-dossier `/srv/nfs_shares/web.tp6.linux/`

> Et ouais pour pas que ce soit le bordel, on va appeler le dossier comme la machine qui l'utilisera :)

ğŸŒ **Installer le serveur NFS** (sur la machine `storage.tp6.linux`)

- installer le paquet `nfs-utils`
- crÃ©er le fichier `/etc/exports`
  - remplissez avec un contenu adaptÃ©
  - j'vous laisse faire les recherches adaptÃ©es pour ce faire
- ouvrir les ports firewall nÃ©cessaires
- dÃ©marrer le service
- je vous laisse check l'internet pour trouver [ce genre de lien](https://www.digitalocean.com/community/tutorials/how-to-set-up-an-nfs-mount-on-rocky-linux-9) pour + de dÃ©tails

### 2. Client NFS

ğŸŒ **Installer un client NFS sur `web.tp6.linux`**

- il devra monter le dossier `/srv/nfs_shares/web.tp6.linux/` qui se trouve sur `storage.tp6.linux`
- le dossier devra Ãªtre montÃ© sur `/srv/backup/`
- je vous laisse lÃ  encore faire vos recherches pour rÃ©aliser Ã§a !
- faites en sorte que le dossier soit automatiquement montÃ© quand la machine s'allume

ğŸŒ **Tester la restauration des donnÃ©es** sinon Ã§a sert Ã  rien :)

- livrez-moi la suite de commande que vous utiliseriez pour restaurer les donnÃ©es dans une version antÃ©rieure

![Backup everything](../pics/backup_everything.jpg)